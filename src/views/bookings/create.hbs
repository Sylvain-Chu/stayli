{{> header }}
{{> sidebar }}
<link rel="stylesheet" href="/css/pages/booking-create-modern.css">

<div class="page-header-sticky">
  <div class="header-content">
    <a href='/bookings' class="back-link">
      <i data-feather="arrow-left"></i>
      <span>{{t 'bookings.title'}}</span>
    </a>
    <h1>{{t 'bookings.createTitle'}}</h1>
  </div>
</div>

{{#if errors}}
  <div class='alert alert-error'>
    <i data-feather="alert-circle"></i>
    <ul>
      {{#each errors}}
        <li>{{this}}</li>
      {{/each}}
    </ul>
  </div>
{{/if}}

<form method='post' action='/bookings/create' class="booking-grid-layout">
  
  <div class="left-column">
    
    <div class="form-section">
      <div class="section-header-row">
        <i data-feather="info"></i>
        <h3>Informations principales</h3>
      </div>
      
      <div class="section-body">
        <div class="row-2">
          <div class="field-group">
            <label for="propertyId">{{t 'bookings.property'}}</label>
            <div class="select-wrapper">
              <select name='propertyId' id='propertyId' required>
                <option value='' disabled {{#unless payload.propertyId}}selected{{/unless}}>{{t 'bookings.selectProperty'}}</option>
                {{#each properties}}
                  <option value='{{this.id}}' {{#if (eq this.id ../payload.propertyId)}}selected{{/if}}>{{this.name}}</option>
                {{/each}}
              </select>
            </div>
          </div>

          <div class="field-group">
            <label for="clientId">{{t 'bookings.client'}}</label>
            <div class="select-wrapper">
              <select name='clientId' id='clientId' required>
                <option value='' disabled {{#unless payload.clientId}}selected{{/unless}}>{{t 'bookings.selectClient'}}</option>
                {{#each clients}}
                  <option value='{{this.id}}' {{#if (eq this.id ../payload.clientId)}}selected{{/if}}>{{this.firstName}} {{this.lastName}}</option>
                {{/each}}
              </select>
            </div>
          </div>
        </div>

        <div class="row-2 mt-4">
          <div class="field-group">
            <label for="startDate">{{t 'bookings.checkIn'}}</label>
            <input type='date' name='startDate' id='startDate' value='{{date payload.startDate}}' required class="input-date" />
          </div>
          <div class="field-group">
            <label for="endDate">{{t 'bookings.checkOut'}}</label>
            <input type='date' name='endDate' id='endDate' value='{{date payload.endDate}}' required class="input-date" />
          </div>
        </div>
        
        <div class="nights-badge" id="nightsBadge" style="display:none;">
          <i data-feather="moon"></i>
          <span id="nightsCount">0</span> {{t 'bookings.nights'}}
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-header-row">
        <i data-feather="users"></i>
        <h3>{{t 'bookings.guests'}}</h3>
      </div>
      <div class="section-body">
        
        <div class="stepper-line">
          <div class="stepper-label">
            <span class="main-label">{{t 'bookings.adults'}}</span>
            <span class="sub-label">13 ans et plus</span>
          </div>
          <div class="stepper-actions">
            <button type="button" class="stepper-btn" data-action="decrease" data-target="adults" data-min="1"><i data-feather="minus"></i></button>
            <input type='number' name='adults' id='adults' min="1" value='{{#if payload.adults}}{{payload.adults}}{{else}}1{{/if}}' readonly />
            <button type="button" class="stepper-btn" data-action="increase" data-target="adults"><i data-feather="plus"></i></button>
          </div>
        </div>

        <div class="separator"></div>

        <div class="stepper-line">
          <div class="stepper-label">
            <span class="main-label">{{t 'bookings.children'}}</span>
            <span class="sub-label">De 2 à 12 ans</span>
          </div>
          <div class="stepper-actions">
            <button type="button" class="stepper-btn" data-action="decrease" data-target="children" data-min="0"><i data-feather="minus"></i></button>
            <input type='number' name='children' id='children' min="0" value='{{#if payload.children}}{{payload.children}}{{else}}0{{/if}}' readonly />
            <button type="button" class="stepper-btn" data-action="increase" data-target="children"><i data-feather="plus"></i></button>
          </div>
        </div>

      </div>
    </div>

    <div class="form-section">
      <div class="section-header-row">
        <i data-feather="layers"></i>
        <h3>{{t 'bookings.options'}}</h3>
      </div>
      <div class="section-body">
        
        <div class="option-line">
          <label class="switch-container">
            <input type='checkbox' name='hasLinens' id='hasLinens' value='true' {{#if payload.hasLinens}}checked{{/if}}>
            <span class="slider"></span>
            <span class="switch-label">{{t 'bookings.hasLinens'}}</span>
          </label>
          <div class="price-input-wrapper">
            <input type='number' step='0.01' name='linensPrice' id='linensPrice' 
                   value='{{#if payload.linensPrice}}{{payload.linensPrice}}{{else}}{{defaultLinensPrice}}{{/if}}' 
                   placeholder="{{defaultLinensPrice}}">
            <span class="currency-symbol">€</span>
          </div>
        </div>

        <div class="separator"></div>

        <div class="option-line">
          <label class="switch-container">
            <input type='checkbox' name='hasCleaning' id='hasCleaning' value='true' {{#if payload.hasCleaning}}checked{{/if}}>
            <span class="slider"></span>
            <span class="switch-label">{{t 'bookings.hasCleaning'}}</span>
          </label>
          <div class="price-input-wrapper">
            <input type='number' step='0.01' name='cleaningPrice' id='cleaningPrice' 
                   value='{{#if payload.cleaningPrice}}{{payload.cleaningPrice}}{{else}}{{defaultCleaningPrice}}{{/if}}' 
                   placeholder="{{defaultCleaningPrice}}">
            <span class="currency-symbol">€</span>
          </div>
        </div>

      </div>
    </div>

    <div class="form-section">
      <div class="section-header-row">
        <i data-feather="credit-card"></i>
        <h3>Paiement</h3>
      </div>
      <div class="section-body">
        
        <div class="option-line">
          <label class="switch-container">
            <input type='checkbox' name='hasCancellationInsurance' id='hasCancellationInsurance' value='true' {{#if payload.hasCancellationInsurance}}checked{{/if}}>
            <span class="slider"></span>
            <div class="label-group">
              <span class="switch-label">{{t 'bookings.hasCancellationInsurance'}}</span>
              <small id="insuranceHint" class="hint-text"></small>
            </div>
          </label>
        </div>

        <div class="separator"></div>

        <div class="discount-wrapper">
          <label for="discount">{{t 'bookings.discount'}}</label>
          <div class="input-group-merged">
            <select name='discountType' id='discountType' class="merged-select">
              <option value='amount' {{#unless payload.discountType}}selected{{/unless}}>€ (Montant)</option>
              <option value='percent' {{#if (eq payload.discountType 'percent')}}selected{{/if}}>% (Pourcent)</option>
            </select>
            <input type='number' step='0.01' name='discount' id='discount' min="0" 
                   value='{{#if payload.discount}}{{payload.discount}}{{else}}0{{/if}}' 
                   class="merged-input" placeholder="0">
          </div>
        </div>

      </div>
    </div>

    <div class="form-section">
      <div class="section-header-row">
        <i data-feather="message-square"></i>
        <h3>Notes</h3>
      </div>
      <div class="section-body">
        <div class="field-group">
          <textarea name='specialRequests' id='specialRequests' rows="3" maxlength="500" placeholder="{{t 'bookings.specialRequests'}}...">{{payload.specialRequests}}</textarea>
          <div class="char-counter">
            <span id="charCount">0</span>/500
          </div>
        </div>
      </div>
    </div>

  </div> <div class="right-column">
    <div class="summary-card" id="summaryCard">
      <div class="summary-header">
        <h3>{{t 'bookings.priceBreakdown'}}</h3>
      </div>
      
      <div class="summary-content">
        <div class="line-item">
          <div class="line-label">
            <span>{{t 'bookings.basePrice'}}</span>
            <small id="basePriceDetail" class="line-sub"></small>
          </div>
          <span class="line-value" id="basePriceDisplay">-</span>
        </div>

        <div class="line-item" id="optionsSection" style="display:none;">
          <div class="line-label">
            <span>{{t 'bookings.options'}}</span>
            <small id="optionsDetail" class="line-sub"></small>
          </div>
          <span class="line-value" id="optionsDisplay">-</span>
        </div>

        <div class="line-item text-success" id="discountSection" style="display:none;">
          <span>{{t 'bookings.discount'}}</span>
          <span class="line-value" id="discountDisplay">-</span>
        </div>

        <div class="summary-divider"></div>

        <div class="line-item">
          <span>{{t 'bookings.insurance'}}</span>
          <span class="line-value" id="insuranceDisplay">-</span>
        </div>

        <div class="line-item">
          <div class="line-label">
            <span>{{t 'bookings.touristTax'}}</span>
            <small id="taxDetail" class="line-sub"></small>
          </div>
          <span class="line-value" id="taxDisplay">-</span>
        </div>

        <div class="summary-total">
          <span>{{t 'bookings.totalPrice'}}</span>
          <span class="total-value" id="totalPriceDisplay">-</span>
        </div>
      </div>

      <div class="summary-footer">
        <button type='submit' class="btn-primary-block">
          <i data-feather="check"></i> {{t 'bookings.createTitle'}}
        </button>
        <a href='/bookings' class="btn-secondary-block">{{t 'common.cancel'}}</a>
      </div>
    </div>
  </div>

</form>

<script src="/js/booking-calculator-enhanced.js"></script>
{{> footer }}